
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Migrating to Puppet 3.x - 电脑</title>
	<meta name="author" content="Nan Liu">

	
	<meta name="description" content="I am a bit late to the Puppet 3.0 party, since 3.1 have been released recently1. After reading the release notes and “The Angry Guide to Puppet 3”, I &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="电脑" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>

<body>
	<header id="header" class="inner"><h1><a href="/">电脑</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:nanliu.github.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/sesshin" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/nanliu" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:nanliu.github.com">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Migrating to Puppet 3.x</h2>
	<div class="entry-content"><p>I am a bit late to the Puppet 3.0 party, since 3.1 have been released recently<sup id="fnref:fn-semver"><a href="#fn:fn-semver" rel="footnote">1</a></sup>. After reading the <a href="http://docs.puppetlabs.com/puppet/3/reference/release_notes.html">release notes</a> and <a href="http://somethingsinistral.net/blog/the-angry-guide-to-puppet-3/">“The Angry Guide to Puppet 3”</a>, I thought most of the upgrade issues have been covered, but there was still a small surprise when it comes to types and providers.</p>

<p>The <a href="http://docs.puppetlabs.com/puppet/3/reference/release_notes.html#exec">Exec resource</a> had a small behavior change noted as: “Due to misleading values, the HOME and USER environment variables are now unset when running commands.”</p>

<p>The impact is a bit more significant than updating Exec resource since it also affects commands declared in providers. If the invoked command depends on the HOME environment variables such as brew, it will fail in Puppet 3:</p>

<pre><code>Error: /Stage[main]//Package[rbenv]:
Could not evaluate: Could not list packages:
Execution of '/usr/local/bin/brew list --versions rbenv' returned 1:
/System/Library/Frameworks/Ruby.framework/Versions/1.8/usr/lib/ruby/1.8/pathname.rb:853:in `expand_path':
couldn't find HOME environment -- expanding `~/Library/Caches/Homebrew' (ArgumentError)
from /System/Library/Frameworks/Ruby.framework/Versions/1.8/usr/lib/ruby/1.8/pathname.rb:853:in `expand_path'
from /usr/local/Library/Homebrew/global.rb:22:in `cache'
from /usr/local/Library/Homebrew/global.rb:41
from /usr/local/bin/brew:17:in `require'
from /usr/local/bin/brew:17
</code></pre>

<p>The solution is described in <a href="http://projects.puppetlabs.com/issues/16779">#16779</a>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Setting command environment variables</span><a href="http://projects.puppetlabs.com/issues/16779">16779 </a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">has_command</span><span class="p">(</span><span class="ss">:brew</span><span class="p">,</span> <span class="s1">&#39;brew&#39;</span><span class="p">)</span> <span class="k">do</span>
</span><span class="line">  <span class="n">environment</span><span class="p">({</span> <span class="s1">&#39;HOME&#39;</span> <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOME&#39;</span><span class="o">]</span> <span class="p">})</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The method ‘has_command’ is not backwards compatible with Puppet 2.x, so we need to wrap it around some version check:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">if</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Util</span><span class="o">::</span><span class="no">Package</span><span class="o">.</span><span class="n">versioncmp</span><span class="p">(</span><span class="no">Puppet</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="s1">&#39;3.0&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
</span><span class="line">  <span class="n">has_command</span><span class="p">(</span><span class="ss">:brew</span><span class="p">,</span> <span class="s2">&quot;/usr/local/bin/brew&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class="line">    <span class="n">environment</span><span class="p">({</span> <span class="s1">&#39;HOME&#39;</span> <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOME&#39;</span><span class="o">]</span> <span class="p">})</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">else</span>
</span><span class="line">  <span class="n">commands</span> <span class="ss">:brew</span> <span class="o">=&gt;</span> <span class="s2">&quot;/usr/local/bin/brew&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">brew</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;--versions&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This also means execute will strip these two environment variables as well, so commands pass :custom_environment to preserve this value. execute is less common, and don’t use it unless you need special behavior such as :failonfail =&gt; false:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">execute</span><span class="p">(</span><span class="o">[</span><span class="n">command</span><span class="p">(</span><span class="ss">:brew</span><span class="p">),</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;--version&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:custom_environment</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;HOME&#39;</span><span class="o">=&gt;</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOME&#39;</span><span class="o">]</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Hope this is helpful for anyone else who stumbles into this issue.</p>

<div class="footnotes">
  <ol>
    <li id="fn:fn-semver">
      <p>The proliferation of versions might be alarming, but it’s due to stricter adherence to semantic versioning. The changes 3.0 3.1 is closer to 2.7.0 to 2.7.1 than 2.6 to 2.7.<a href="#fnref:fn-semver" rel="reference">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-02-08T01:52:00-08:00" pubdate data-updated="true">Feb 8<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/providers/'>providers</a>, <a class='category' href='/blog/categories/puppet/'>puppet</a>, <a class='category' href='/blog/categories/types/'>types</a>


</div>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2013

    Nan Liu

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>